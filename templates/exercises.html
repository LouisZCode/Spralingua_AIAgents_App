{% extends "base.html" %}

{% block title %}Learning Hub - Your Language Journey{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/exercises.css') }}?v={{ timestamp }}">
{% endblock %}

{% block content %}
    <!-- Topic Completion Popup -->
    <div id="completion-popup" class="completion-popup-overlay" style="display: none;">
        <div class="completion-popup-content">
            <div class="popup-icon">üéâ</div>
            <h2 class="popup-title" id="popup-title">You finished Topic 1!</h2>
            <p class="popup-subtitle" id="popup-subtitle">Ready to move to Topic 2?</p>

            <div class="popup-buttons">
                <button class="popup-btn popup-btn-yes" id="popup-yes-btn">
                    <span id="popup-yes-text">Yes, Let's Go!</span>
                </button>
                <button class="popup-btn popup-btn-stay" id="popup-stay-btn">
                    <span id="popup-stay-text">Stay Here</span>
                </button>
            </div>

            <div class="popup-stay-message" id="popup-stay-message" style="display: none;">
                <p>You can move to the next topic anytime by clicking on it in the progress bar above!</p>
            </div>
        </div>
    </div>

    <div class="hub-container">
        <!-- Back Navigation -->
        <div class="back-nav-container">
            <a href="{{ url_for('dashboard') }}" class="back-nav-button">
                <span class="back-arrow">‚Üê</span>
                <span data-translate="back_to_dashboard">Back to Language Selection</span>
            </a>
        </div>
        
        <!-- Header Section -->
        <div class="hub-header">
            <h1 class="hub-title" data-translate="learning_hub">Learning Hub</h1>
            <p class="hub-subtitle" data-translate="learning_journey">Your personalized language learning journey</p>
            {% if current_user %}
                <p class="user-greeting">Welcome back, {{ current_user.display_name or current_user.username }}!</p>
            {% endif %}
        </div>
        
        <!-- Progress Timeline Section -->
        <div class="progress-section">
            <div class="progress-container">
                <!-- Centered Current Level -->
                <div class="progress-header-centered">
                    <h3 class="progress-title-centered">
                        <span data-translate="current_level">Current Level</span>:
                        <span id="current-level-display">A1</span>
                    </h3>
                </div>

                <!-- Centered Topic Title (above carousel) -->
                <div class="topic-title-display">
                    <span id="topic-title-text">Who are you?</span>
                </div>

                <!-- Carousel Container -->
                <div class="carousel-wrapper">
                    <!-- Left Arrow (hidden if can't go left) -->
                    <button class="carousel-arrow carousel-arrow-left" id="carousel-left" aria-label="Previous topic">
                        ‚Üê
                    </button>

                    <!-- Carousel Track (5 visible nodes) -->
                    <div class="carousel-track-container">
                        <div class="carousel-track" id="carousel-track">
                            <!-- Nodes populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Right Arrow (hidden if can't go right) -->
                    <button class="carousel-arrow carousel-arrow-right" id="carousel-right" aria-label="Next topic">
                        ‚Üí
                    </button>
                </div>

                <!-- Centered Topic Counter (below carousel) -->
                <div class="topic-counter-display">
                    <span data-translate="topic">Topic</span>
                    <span id="current-topic-display">1</span> / 16
                </div>
            </div>
        </div>

        <!-- Practice Modules Grid -->
        <div class="modules-section">
            <h2 class="section-title" data-translate="practice_modules">Practice Modules</h2>

            <!-- Conversation Practice Module Section -->
            <div class="module-section">
                <!-- Wide Module Header Card -->
                <div class="module-header-card">
                    <div class="module-header-content">
                        <div class="module-avatar">
                            <img src="{{ url_for('static', filename='images/avatars/harry_profile.png') }}" alt="Harry" class="avatar-image">
                        </div>
                        <div class="module-info">
                            <h3 class="module-header-title" data-translate="conversation_practice">Conversation Practice</h3>
                            <p class="module-header-description" data-translate="conversation_practice_desc">Practice natural conversations with our AI tandems</p>
                        </div>
                    </div>
                    <div class="module-header-decoration"></div>
                </div>

                <!-- Exercise Cards Grid -->
                <div class="module-exercises-grid">
                    <a href="{{ url_for('casual_chat') }}" class="practice-exercise-box" id="casual-chat-link">
                        <div class="exercise-completion-indicator" id="casual-chat-indicator">
                            <span class="completion-circle"></span>
                        </div>
                        <span class="practice-exercise-icon">‚òï</span>
                        <div class="practice-exercise-title" data-translate="casual_chat">Casual Chat</div>
                        <div class="practice-exercise-subtitle" data-translate="everyday_conversations">Everyday conversations</div>
                    </a>
                    <div class="practice-exercise-box disabled">
                        <div class="coming-soon-ribbon" data-translate="coming_soon">Coming Soon</div>
                        <span class="practice-exercise-icon">ü§™‚ùì</span>
                        <div class="practice-exercise-title" data-translate="correct_kevin">Correct Kevin</div>
                        <div class="practice-exercise-subtitle" data-translate="fix_mistakes">Fix the mistakes</div>
                    </div>
                </div>
            </div>

            <!-- Writing Practice Module Section -->
            <div class="module-section">
                <!-- Wide Module Header Card -->
                <div class="module-header-card">
                    <div class="module-header-content">
                        <div class="module-avatar">
                            <img src="{{ url_for('static', filename='images/avatars/sally_profile.png') }}" alt="Sally" class="avatar-image">
                        </div>
                        <div class="module-info">
                            <h3 class="module-header-title" data-translate="writing_practice">Writing Practice</h3>
                            <p class="module-header-description" data-translate="writing_practice_desc">Improve your written communication skills</p>
                        </div>
                    </div>
                    <div class="module-header-decoration"></div>
                </div>

                <!-- Exercise Cards Grid -->
                <div class="module-exercises-grid">
                    <a href="/writing-practice" class="practice-exercise-box" id="email-writing-link">
                        <div class="exercise-completion-indicator" id="email-writing-indicator">
                            <span class="completion-circle"></span>
                        </div>
                        <span class="practice-exercise-icon">üìß</span>
                        <div class="practice-exercise-title" data-translate="email_writing">Email Writing</div>
                        <div class="practice-exercise-subtitle" data-translate="professional_emails">Professional emails</div>
                    </a>
                    <div class="practice-exercise-box disabled">
                        <div class="coming-soon-ribbon" data-translate="coming_soon">Coming Soon</div>
                        <span class="practice-exercise-icon">üî§</span>
                        <div class="practice-exercise-title" data-translate="fill_blanks">Fill the Blanks</div>
                        <div class="practice-exercise-subtitle" data-translate="grammar_practice">Grammar practice</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Load user progress when page loads
    document.addEventListener('DOMContentLoaded', async function() {
        const currentTopic = await loadUserProgress();
        console.log('[DEBUG] currentTopic from loadUserProgress:', currentTopic);
        await checkCompletionPopup();
        setupPopupEventHandlers();
        updateExerciseLinks(currentTopic);
    });

    async function loadUserProgress() {
        try {
            // Get current language pair from localStorage (set by dashboard)
            const inputLang = localStorage.getItem('selectedInputLanguage');
            const targetLang = localStorage.getItem('selectedTargetLanguage');

            if (!inputLang || !targetLang) {
                console.error('No language pair selected');
                // Show error message and redirect to dashboard
                showErrorMessage('Please select your languages first. Redirecting to dashboard...');
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 2000);
                return;
            }

            // Language pair change detection
            const lastInputLang = localStorage.getItem('lastInputLanguage');
            const lastTargetLang = localStorage.getItem('lastTargetLanguage');

            if (lastInputLang && lastTargetLang) {
                // Check if language pair has changed
                if (lastInputLang !== inputLang || lastTargetLang !== targetLang) {
                    console.log('[LANGUAGE CHANGE] Detected language pair change');
                    console.log(`[LANGUAGE CHANGE] From: ${lastInputLang}->${lastTargetLang} To: ${inputLang}->${targetLang}`);

                    // Clear viewing topics for all language pairs since we're switching
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith('viewingTopic_')) {
                            console.log(`[LANGUAGE CHANGE] Clearing ${key}`);
                            localStorage.removeItem(key);
                        }
                    });
                }
            }

            // Store current language pair for next time
            localStorage.setItem('lastInputLanguage', inputLang);
            localStorage.setItem('lastTargetLanguage', targetLang);

            // Fetch progress data
            const response = await fetch(`/api/user-progress?input_language=${inputLang}&target_language=${targetLang}`);

            if (!response.ok) {
                console.error(`Failed to load progress: ${response.status}`);
                // Show error message
                showErrorMessage('Unable to load your progress. Please try again.');
                return;
            }

            const progressData = await response.json();
            console.log('Progress data received:', progressData);

            // Check if we have valid data structure
            if (!progressData.topics || !progressData.tests) {
                console.error('Invalid progress data structure');
                showErrorMessage('Invalid data received. Please try refreshing the page.');
                return;
            }

            console.log('[DEBUG] About to call displayProgress with:', progressData);
            const currentDisplayTopic = displayProgress(progressData);
            console.log('[DEBUG] displayProgress returned:', typeof currentDisplayTopic, currentDisplayTopic);
            console.log('[DEBUG] loadUserProgress got currentDisplayTopic:', currentDisplayTopic);

            // Return the current display topic for use in the main handler
            return currentDisplayTopic;

        } catch (error) {
            console.error('Error loading progress:', error);
            // Show error message
            showErrorMessage('An error occurred while loading your progress. Please try again.');
        }
    }

    function showErrorMessage(message) {
        // Create error overlay
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-overlay';
        errorDiv.innerHTML = `
            <div class="error-message">
                <p>${message}</p>
            </div>
        `;

        // Add styles if not already present
        if (!document.querySelector('style[data-error-styles]')) {
            const style = document.createElement('style');
            style.setAttribute('data-error-styles', 'true');
            style.textContent = `
                .error-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                }
                .error-message {
                    background: white;
                    padding: 2rem;
                    border-radius: 10px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                    max-width: 400px;
                    text-align: center;
                }
                .error-message p {
                    margin: 0;
                    font-size: 1.1rem;
                    color: #721c24;
                }
            `;
            document.head.appendChild(style);
        }

        document.body.appendChild(errorDiv);
    }

    // NEW: Carousel State
    let carouselState = {
        currentCenterIndex: 0, // Index in topics array (0-15)
        topics: [],
        maxAccessibleIndex: 0,
        totalTopics: 16
    };

    function displayProgress(data) {
        // Get current language pair for context-aware storage
        const inputLang = localStorage.getItem('selectedInputLanguage');
        const targetLang = localStorage.getItem('selectedTargetLanguage');

        // Migrate old viewingTopic key if it exists
        const oldViewingTopic = localStorage.getItem('viewingTopic');
        if (oldViewingTopic) {
            console.log('[MIGRATION] Removing old global viewingTopic key');
            localStorage.removeItem('viewingTopic');
        }

        // Use context-aware key for viewing topic
        const contextKey = `viewingTopic_${inputLang}_${targetLang}`;
        const storedViewingTopic = localStorage.getItem(contextKey);
        let displayTopic = storedViewingTopic ? parseInt(storedViewingTopic) : data.current_topic;

        // Validate that the viewing topic is accessible for this user
        if (displayTopic) {
            // Check if this topic is actually available
            const topicData = data.topics.find(t => t.topic_number === displayTopic);
            if (!topicData || topicData.locked) {
                console.log(`[VALIDATION] Topic ${displayTopic} is not accessible, resetting to current topic ${data.current_topic}`);
                displayTopic = data.current_topic;
                // Clear invalid stored value
                localStorage.removeItem(contextKey);
            }
        }

        // Update level and topic displays
        document.getElementById('current-level-display').textContent = data.current_level;
        document.getElementById('current-topic-display').textContent = displayTopic;

        // Store for use in other functions
        data.display_topic = displayTopic;

        // Update exercise completion indicators for the viewing topic
        updateExerciseCompletionIndicators(data);

        // NEW: Initialize carousel with topics
        initializeCarousel(data.topics, displayTopic);

        // Return the display topic for use in updateExerciseLinks
        console.log('[DEBUG] displayProgress returning displayTopic:', displayTopic);
        return displayTopic;
    }

    // NEW: Initialize Carousel
    function initializeCarousel(topics, displayTopic) {
        carouselState.topics = topics;

        // Find max accessible topic
        carouselState.maxAccessibleIndex = topics.findIndex(t => t.locked);
        if (carouselState.maxAccessibleIndex === -1) {
            carouselState.maxAccessibleIndex = topics.length - 1;
        } else {
            carouselState.maxAccessibleIndex = Math.max(0, carouselState.maxAccessibleIndex - 1);
        }

        // Set initial center topic
        const displayIndex = topics.findIndex(t => t.topic_number === displayTopic);
        carouselState.currentCenterIndex = displayIndex >= 0 ? displayIndex : 0;

        renderCarousel();
        updateArrowStates();
    }

    // NEW: Render Carousel Nodes
    function renderCarousel() {
        const track = document.getElementById('carousel-track');
        track.innerHTML = '';

        carouselState.topics.forEach((topic, index) => {
            const node = createCarouselNode(topic, index);
            track.appendChild(node);
        });

        updateCarouselPosition();
        updateTopicNameDisplay();
    }

    // NEW: Create Individual Carousel Node (simplified - no red triangle, no absolute positioning)
    function createCarouselNode(topic, index) {
        const nodeDiv = document.createElement('div');
        nodeDiv.className = 'timeline-node';
        nodeDiv.dataset.index = index;

        // Apply status classes
        if (topic.completed) nodeDiv.classList.add('completed');
        else if (topic.locked) nodeDiv.classList.add('locked');
        else nodeDiv.classList.add('available');

        if (topic.current) nodeDiv.classList.add('progression-topic');

        // Center class for opacity
        if (index === carouselState.currentCenterIndex) {
            nodeDiv.classList.add('carousel-center');
        }

        // Circle with number or emoji
        const circle = document.createElement('div');
        circle.className = 'node-circle';
        const isTestTopic = [4, 8, 12, 16].includes(topic.topic_number);
        if (isTestTopic) {
            circle.classList.add('test-circle');
            circle.innerHTML = 'üìù';
            nodeDiv.classList.add('test-node');
        } else {
            circle.textContent = topic.topic_number;
            nodeDiv.classList.add('topic-node');
        }
        nodeDiv.appendChild(circle);

        // Add tooltip
        nodeDiv.title = `Topic ${topic.topic_number}: ${getTopicTitle(topic.title)}`;

        // Click handler (only for unlocked topics)
        if (!topic.locked) {
            nodeDiv.onclick = () => navigateToCarouselIndex(index);
        }

        return nodeDiv;
    }

    // NEW: Update Carousel Position (transform animation)
    function updateCarouselPosition() {
        const track = document.getElementById('carousel-track');
        const nodeWidth = 48;
        const gap = 8;
        const offset = carouselState.currentCenterIndex * (nodeWidth + gap);

        // Center the current topic (5 visible = 2 left + center + 2 right)
        const centerOffset = 2 * (nodeWidth + gap);
        track.style.transform = `translateX(${centerOffset - offset}px)`;

        // Update opacity classes
        document.querySelectorAll('.timeline-node').forEach((node, index) => {
            if (index === carouselState.currentCenterIndex) {
                node.classList.add('carousel-center');
            } else {
                node.classList.remove('carousel-center');
            }
        });
    }

    // NEW: Navigate to Specific Index
    async function navigateToCarouselIndex(index) {
        const topic = carouselState.topics[index];

        // Prevent navigation to locked topics
        if (topic.locked) return;

        carouselState.currentCenterIndex = index;
        updateCarouselPosition();
        updateTopicNameDisplay();
        updateArrowStates();

        // Save to localStorage
        const inputLang = localStorage.getItem('selectedInputLanguage');
        const targetLang = localStorage.getItem('selectedTargetLanguage');
        const contextKey = `viewingTopic_${inputLang}_${targetLang}`;
        localStorage.setItem(contextKey, topic.topic_number);

        // Update exercise links
        updateExerciseLinks(topic.topic_number);

        // Call backend API to update server state
        await navigateToTopic(topic.topic_number);
    }

    // NEW: Arrow Navigation
    function navigateCarouselLeft() {
        if (carouselState.currentCenterIndex > 0) {
            navigateToCarouselIndex(carouselState.currentCenterIndex - 1);
        }
    }

    function navigateCarouselRight() {
        const nextIndex = carouselState.currentCenterIndex + 1;
        const nextTopic = carouselState.topics[nextIndex];

        if (nextIndex < carouselState.topics.length && !nextTopic.locked) {
            navigateToCarouselIndex(nextIndex);
        }
    }

    // NEW: Update Arrow States (show/hide based on position + locks)
    function updateArrowStates() {
        const leftArrow = document.getElementById('carousel-left');
        const rightArrow = document.getElementById('carousel-right');

        // Left arrow: disabled if at start
        leftArrow.disabled = carouselState.currentCenterIndex === 0;

        // Right arrow: disabled if at end OR next topic is locked
        const nextIndex = carouselState.currentCenterIndex + 1;
        const nextTopic = carouselState.topics[nextIndex];
        const atEnd = nextIndex >= carouselState.topics.length;
        const nextLocked = nextTopic && nextTopic.locked;

        rightArrow.disabled = atEnd || nextLocked;
    }

    // NEW: Update Topic Title and Counter Display
    function updateTopicNameDisplay() {
        const topic = carouselState.topics[carouselState.currentCenterIndex];
        const titleDisplay = document.getElementById('topic-title-text');
        const counterDisplay = document.getElementById('current-topic-display');

        if (topic) {
            // Get target language for immersion (display in language being learned)
            const targetLang = localStorage.getItem('selectedTargetLanguage');

            // Get translated title in TARGET language from translations system
            const titleKey = topic.title;
            const translatedTitle = window.translationManager
                ? window.translationManager.getTextInLanguage(titleKey, targetLang)
                : titleKey;

            // Update title above carousel
            titleDisplay.textContent = translatedTitle;

            // Update counter below carousel
            counterDisplay.textContent = topic.topic_number;
        }
    }

    // NEW: Touch Swipe Support
    let touchStartX = 0;
    let touchEndX = 0;

    function handleTouchStart(e) {
        touchStartX = e.changedTouches[0].screenX;
    }

    function handleTouchEnd(e) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    }

    function handleSwipe() {
        const swipeThreshold = 50;
        const diff = touchStartX - touchEndX;

        if (Math.abs(diff) > swipeThreshold) {
            if (diff > 0) {
                // Swipe left = navigate right
                navigateCarouselRight();
            } else {
                // Swipe right = navigate left
                navigateCarouselLeft();
            }
        }
    }

    // NEW: Event Listeners (add after DOM loaded)
    setTimeout(() => {
        document.getElementById('carousel-left')?.addEventListener('click', navigateCarouselLeft);
        document.getElementById('carousel-right')?.addEventListener('click', navigateCarouselRight);

        const trackContainer = document.querySelector('.carousel-track-container');
        trackContainer?.addEventListener('touchstart', handleTouchStart);
        trackContainer?.addEventListener('touchend', handleTouchEnd);
    }, 100);

    function updateExerciseLinks(defaultTopic) {
        console.log('[DEBUG] updateExerciseLinks called with defaultTopic:', defaultTopic);

        // Get current language pair for context-aware storage
        const inputLang = localStorage.getItem('selectedInputLanguage');
        const targetLang = localStorage.getItem('selectedTargetLanguage');

        // Use context-aware key for viewing topic
        const contextKey = `viewingTopic_${inputLang}_${targetLang}`;
        let viewingTopic = localStorage.getItem(contextKey);
        console.log('[DEBUG] viewingTopic from localStorage:', viewingTopic);

        // Use default topic if no saved viewing topic
        if (!viewingTopic && defaultTopic) {
            viewingTopic = defaultTopic;
            console.log('[DEBUG] Using defaultTopic as viewingTopic:', viewingTopic);
        }

        if (viewingTopic) {
            // Update casual chat link
            const casualChatLink = document.getElementById('casual-chat-link');
            if (casualChatLink) {
                casualChatLink.href = `/casual-chat?topic=${viewingTopic}`;
            }

            // Update email writing link
            const emailWritingLink = document.getElementById('email-writing-link');
            if (emailWritingLink) {
                emailWritingLink.href = `/writing-practice?topic=${viewingTopic}`;
            }
        }
    }

    function updateExerciseCompletionIndicators(data) {
        // Use viewing topic if set, otherwise current topic
        const topicToShow = data.display_topic || data.current_topic;

        // Find topic data for the viewing/current topic
        const currentTopicData = data.topics.find(t => t.topic_number === topicToShow);

        if (!currentTopicData || !currentTopicData.exercises) {
            console.log('No exercise data for current topic');
            return;
        }

        // Update Casual Chat indicator
        const casualChatIndicator = document.getElementById('casual-chat-indicator');
        if (casualChatIndicator && currentTopicData.exercises.casual_chat) {
            const status = currentTopicData.exercises.casual_chat.status;
            updateCompletionIndicator(casualChatIndicator, status);
        }

        // Update Email Writing indicator
        const emailWritingIndicator = document.getElementById('email-writing-indicator');
        if (emailWritingIndicator && currentTopicData.exercises.email_writing) {
            const status = currentTopicData.exercises.email_writing.status;
            updateCompletionIndicator(emailWritingIndicator, status);
        }
    }

    function updateCompletionIndicator(indicatorElement, status) {
        const circle = indicatorElement.querySelector('.completion-circle');
        if (!circle) return;

        // Remove all status classes
        circle.classList.remove('not-started', 'in-progress', 'completed');

        // Add appropriate class and content based on status
        switch(status) {
            case 'completed':
                circle.classList.add('completed');
                circle.innerHTML = '‚úì';
                break;
            case 'in_progress':
                circle.classList.add('in-progress');
                circle.innerHTML = '‚óê';  // Half-filled circle
                break;
            case 'not_started':
            default:
                circle.classList.add('not-started');
                circle.innerHTML = '';
                break;
        }
    }


    async function navigateToTopic(topicNumber) {
        // Navigate to a different topic
        try {
            const inputLang = localStorage.getItem('selectedInputLanguage');
            const targetLang = localStorage.getItem('selectedTargetLanguage');

            const response = await fetch('/api/navigate-to-topic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    topic_number: topicNumber,
                    input_language: inputLang,
                    target_language: targetLang
                })
            });

            if (response.ok) {
                const result = await response.json();
                console.log(`[SUCCESS] Navigated to Topic ${topicNumber}`);

                // Use context-aware key for storing the selected topic
                const contextKey = `viewingTopic_${inputLang}_${targetLang}`;
                localStorage.setItem(contextKey, topicNumber);

                // Update exercise links immediately
                updateExerciseLinks();

                // Reload page to refresh progress display
                window.location.reload();
            } else {
                const error = await response.json();
                console.error('[ERROR] Navigation failed:', error);
                alert(error.error || 'Cannot navigate to this topic');
            }
        } catch (error) {
            console.error('[ERROR] Navigation request failed:', error);
        }
    }




    function getTopicTitle(titleKey) {
        // Get target language for immersion (tooltips also in target language)
        const targetLang = localStorage.getItem('selectedTargetLanguage');

        // Try to get translated title in TARGET language, fallback to key
        if (window.translationManager) {
            return window.translationManager.getTextInLanguage(titleKey, targetLang) || titleKey;
        }
        return titleKey;
    }

    async function checkCompletionPopup() {
        // Check if we should show a completion popup
        try {
            const inputLang = localStorage.getItem('selectedInputLanguage');
            const targetLang = localStorage.getItem('selectedTargetLanguage');

            if (!inputLang || !targetLang) {
                return;
            }

            const response = await fetch(`/api/check-completion-popup?input_language=${inputLang}&target_language=${targetLang}`);

            if (response.ok) {
                const data = await response.json();

                if (data.show_popup) {
                    showCompletionPopup(data);
                }
            }
        } catch (error) {
            console.error('[ERROR] Checking completion popup:', error);
        }
    }

    function showCompletionPopup(popupData) {
        const popup = document.getElementById('completion-popup');
        const title = document.getElementById('popup-title');
        const subtitle = document.getElementById('popup-subtitle');
        const yesText = document.getElementById('popup-yes-text');

        // Store popup data for button handlers
        popup.dataset.completedTopic = popupData.completed_topic;
        popup.dataset.nextNumber = popupData.next_item.topic_number;

        // Check if next topic is a test (positions 4, 8, 12, 16)
        const nextIsTest = [4, 8, 12, 16].includes(popupData.next_item.topic_number);

        if (nextIsTest) {
            // Test popup
            title.textContent = `You finished Topic ${popupData.completed_topic}!`;
            subtitle.textContent = `Ready for Checkpoint Test ${[4, 8, 12, 16].indexOf(popupData.next_item.topic_number) + 1}?`;
            yesText.textContent = 'Take the Test';

            // Update icon for test
            document.querySelector('.popup-icon').textContent = 'üìù';
        } else {
            // Regular topic progression
            title.textContent = `You finished Topic ${popupData.completed_topic}!`;
            subtitle.textContent = `Do you want to move to Topic ${popupData.next_item.topic_number}?`;
            yesText.textContent = 'Yes, Let\'s Go!';

            // Update icon for topic
            document.querySelector('.popup-icon').textContent = 'üéâ';
        }

        // Show the popup
        popup.style.display = 'flex';
    }

    function setupPopupEventHandlers() {
        const popup = document.getElementById('completion-popup');
        const yesBtn = document.getElementById('popup-yes-btn');
        const stayBtn = document.getElementById('popup-stay-btn');
        const stayMessage = document.getElementById('popup-stay-message');

        yesBtn.addEventListener('click', async function() {
            const completedTopic = parseInt(popup.dataset.completedTopic);
            const nextNumber = parseInt(popup.dataset.nextNumber);

            // Mark popup as seen
            await markPopupSeen(completedTopic);

            // Get current language pair for context-aware storage
            const inputLang = localStorage.getItem('selectedInputLanguage');
            const targetLang = localStorage.getItem('selectedTargetLanguage');

            // Clear viewing topic since we're moving forward (use context-aware key)
            const contextKey = `viewingTopic_${inputLang}_${targetLang}`;
            localStorage.removeItem(contextKey);

            // Navigate to next topic (tests are now just topics)
            await navigateToTopic(nextNumber);
        });

        stayBtn.addEventListener('click', async function() {
            const completedTopic = parseInt(popup.dataset.completedTopic);

            // Mark popup as seen
            await markPopupSeen(completedTopic);

            // Show the stay message
            stayMessage.style.display = 'block';

            // Hide popup after 3 seconds
            setTimeout(() => {
                popup.style.display = 'none';
                stayMessage.style.display = 'none';
            }, 3000);
        });
    }

    async function markPopupSeen(topicNumber) {
        try {
            const inputLang = localStorage.getItem('selectedInputLanguage');
            const targetLang = localStorage.getItem('selectedTargetLanguage');

            await fetch('/api/mark-popup-seen', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    topic_number: topicNumber,
                    input_language: inputLang,
                    target_language: targetLang
                })
            });
        } catch (error) {
            console.error('[ERROR] Marking popup seen:', error);
        }
    }

    function updateExerciseAccessibility(progressData) {
        // Get exercise links
        const casualChatLink = document.getElementById('casual-chat-link');
        const emailWritingLink = document.getElementById('email-writing-link');

        // Check if there's a blocking test
        const currentItem = progressData.current_item;

        if (currentItem && currentItem.type === 'test') {
            // User needs to complete a test before continuing
            disableExerciseLink(casualChatLink, `Complete ${currentItem.message} first`);
            disableExerciseLink(emailWritingLink, `Complete ${currentItem.message} first`);

            // Show test notification
            showTestNotification(currentItem);
        } else if (currentItem && currentItem.type === 'topic') {
            // Exercises are available for current topic
            enableExerciseLink(casualChatLink);
            enableExerciseLink(emailWritingLink);
        } else if (currentItem && currentItem.type === 'completed') {
            // Level completed - exercises can still be accessed
            enableExerciseLink(casualChatLink);
            enableExerciseLink(emailWritingLink);

            // Check if this is B2 completion
            if (progressData.current_level === 'B2' && progressData.overall_progress === 100) {
                showLanguageCompletionPopup();
            }
        }
    }

    function disableExerciseLink(linkElement, reason) {
        if (!linkElement) return;

        linkElement.classList.add('disabled');
        linkElement.style.pointerEvents = 'none';
        linkElement.style.opacity = '0.5';
        linkElement.title = reason;

        // Prevent navigation
        linkElement.onclick = function(e) {
            e.preventDefault();
            showBlockedMessage(reason);
            return false;
        };
    }

    function enableExerciseLink(linkElement) {
        if (!linkElement) return;

        linkElement.classList.remove('disabled');
        linkElement.style.pointerEvents = 'auto';
        linkElement.style.opacity = '1';
        linkElement.title = '';
        linkElement.onclick = null;  // Remove click handler
    }

    function showBlockedMessage(message) {
        // Create temporary message
        const msgDiv = document.createElement('div');
        msgDiv.className = 'blocked-message';
        msgDiv.textContent = message;
        msgDiv.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ff6b6b;
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            font-weight: 600;
            animation: fadeInOut 3s ease;
        `;

        document.body.appendChild(msgDiv);

        setTimeout(() => {
            msgDiv.remove();
        }, 3000);
    }

    function showTestNotification(testInfo) {
        // Create test notification banner
        const banner = document.createElement('div');
        banner.className = 'test-notification';
        banner.innerHTML = `
            <div style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
                        padding: 1rem;
                        border-radius: 10px;
                        margin: 1rem 0;
                        text-align: center;
                        box-shadow: 0 4px 15px rgba(255,154,158,0.3);">
                <h3 style="color: #721c24; margin: 0 0 0.5rem 0;">Test Required!</h3>
                <p style="color: #721c24; margin: 0;">${testInfo.message}</p>
                <button onclick="window.location.href='/test/${testInfo.test_type}'"
                        style="margin-top: 1rem;
                               padding: 0.5rem 2rem;
                               background: white;
                               color: #ff6b6b;
                               border: none;
                               border-radius: 5px;
                               font-weight: 600;
                               cursor: pointer;">
                    Take Test
                </button>
            </div>
        `;

        // Insert after progress section
        const progressSection = document.querySelector('.progress-section');
        if (progressSection && !document.querySelector('.test-notification')) {
            progressSection.insertAdjacentElement('afterend', banner);
        }
    }

    function showLanguageCompletionPopup() {
        // Create congratulations popup for B2 completion
        const popup = document.createElement('div');
        popup.className = 'level-completion-popup';
        popup.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.5s ease;
        `;

        const targetLang = localStorage.getItem('selectedTargetLanguage') || 'the language';

        popup.innerHTML = `
            <div style="background: white;
                        border-radius: 20px;
                        padding: 3rem;
                        max-width: 500px;
                        text-align: center;
                        position: relative;
                        animation: slideUp 0.5s ease;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">üéâüéäüèÜ</div>
                <h1 style="color: #667eea;
                           font-size: 2.5rem;
                           margin-bottom: 1rem;
                           background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                           -webkit-background-clip: text;
                           -webkit-text-fill-color: transparent;">
                    Congratulations!
                </h1>
                <p style="font-size: 1.2rem;
                          color: #333;
                          margin-bottom: 1.5rem;
                          line-height: 1.6;">
                    You have successfully completed <strong>B2 level</strong> in ${targetLang}!
                </p>
                <p style="font-size: 1rem;
                          color: #666;
                          margin-bottom: 2rem;">
                    You have mastered all 48 topics and passed all tests. This is an incredible achievement!
                    You can now communicate fluently in ${targetLang}.
                </p>
                <div style="background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
                            padding: 1rem;
                            border-radius: 10px;
                            margin-bottom: 2rem;">
                    <p style="color: white; font-weight: 600; margin: 0;">
                        Your journey: A1 ‚Üí A2 ‚Üí B1 ‚Üí B2 ‚úÖ
                    </p>
                </div>
                <button onclick="this.closest('.level-completion-popup').remove()"
                        style="padding: 1rem 3rem;
                               background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                               color: white;
                               border: none;
                               border-radius: 8px;
                               font-size: 1.1rem;
                               font-weight: 600;
                               cursor: pointer;
                               transition: transform 0.2s;">
                    Continue Learning
                </button>
            </div>
        `;

        document.body.appendChild(popup);

        // Add confetti effect
        createConfetti();
    }

    function showLevelAdvancementPopup(fromLevel, toLevel) {
        // Create level advancement popup (for A1->A2, A2->B1, B1->B2)
        const popup = document.createElement('div');
        popup.className = 'level-advancement-popup';
        popup.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.5s ease;
        `;

        popup.innerHTML = `
            <div style="background: white;
                        border-radius: 20px;
                        padding: 3rem;
                        max-width: 500px;
                        text-align: center;
                        position: relative;
                        animation: slideUp 0.5s ease;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üéØ‚ú®</div>
                <h1 style="color: #667eea;
                           font-size: 2rem;
                           margin-bottom: 1rem;">
                    Level Complete!
                </h1>
                <p style="font-size: 1.2rem;
                          color: #333;
                          margin-bottom: 1.5rem;">
                    Congratulations on completing <strong>${fromLevel}</strong>!
                </p>
                <div style="display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 2rem;
                            margin: 2rem 0;">
                    <div style="background: #f0f0f0;
                                padding: 1rem 2rem;
                                border-radius: 10px;
                                font-size: 1.5rem;
                                font-weight: 600;
                                color: #666;">
                        ${fromLevel}
                    </div>
                    <div style="font-size: 2rem;">‚Üí</div>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                padding: 1rem 2rem;
                                border-radius: 10px;
                                font-size: 1.5rem;
                                font-weight: 600;
                                color: white;">
                        ${toLevel}
                    </div>
                </div>
                <p style="font-size: 1rem;
                          color: #666;
                          margin-bottom: 2rem;">
                    Ready to advance to the next level?
                </p>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button onclick="advanceToNextLevel('${toLevel}')"
                            style="padding: 1rem 2rem;
                                   background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                   color: white;
                                   border: none;
                                   border-radius: 8px;
                                   font-weight: 600;
                                   cursor: pointer;">
                        Start ${toLevel}
                    </button>
                    <button onclick="this.closest('.level-advancement-popup').remove()"
                            style="padding: 1rem 2rem;
                                   background: #f0f0f0;
                                   color: #333;
                                   border: none;
                                   border-radius: 8px;
                                   font-weight: 600;
                                   cursor: pointer;">
                        Continue ${fromLevel}
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(popup);
    }

    function createConfetti() {
        // Simple confetti animation
        const colors = ['#667eea', '#764ba2', '#ffd89b', '#19547b', '#ff6b6b'];
        const confettiCount = 100;

        for (let i = 0; i < confettiCount; i++) {
            const confetti = document.createElement('div');
            confetti.style.cssText = `
                position: fixed;
                width: 10px;
                height: 10px;
                background: ${colors[Math.floor(Math.random() * colors.length)]};
                left: ${Math.random() * 100}%;
                top: -10px;
                opacity: ${Math.random()};
                transform: rotate(${Math.random() * 360}deg);
                animation: confettiFall ${3 + Math.random() * 2}s linear;
                z-index: 10001;
            `;
            document.body.appendChild(confetti);

            setTimeout(() => confetti.remove(), 5000);
        }
    }

    async function advanceToNextLevel(newLevel) {
        // Call API to advance level
        try {
            const response = await fetch('/api/advance-level', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ new_level: newLevel })
            });

            if (response.ok) {
                // Reload page to refresh progress
                window.location.reload();
            }
        } catch (error) {
            console.error('Error advancing level:', error);
        }
    }

    // Add CSS for animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);

    // Modify the existing loadUserProgress function to call updateExerciseAccessibility
    const originalLoadUserProgress = loadUserProgress;
    loadUserProgress = async function() {
        const result = await originalLoadUserProgress();
        return result;  // IMPORTANT: Return the result from the original function
    };

    // Modify displayProgress to also update exercise accessibility
    const originalDisplayProgress = displayProgress;
    displayProgress = function(data) {
        const result = originalDisplayProgress(data);
        updateExerciseAccessibility(data);
        return result;  // IMPORTANT: Return the result from the original function
    };
</script>
{% endblock %}